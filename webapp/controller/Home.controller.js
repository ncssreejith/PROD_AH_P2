sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","../util/dataUtil","sap/m/MessageBox","sap/base/Log"],function(e,t,n,i,r,o){"use strict";return e.extend("eslm.login.Bio-Login.controller.Home",{onInit:function(){try{var e=this;e.ResourceBundle=e.getOwnerComponent().getModel("i18n").getResourceBundle();var t=jQuery.sap.getUriParameters().get("device");this.fingerErrorCount=0;t=t!==null&&t.length>0?t:"default";var n=new sap.ui.model.json.JSONModel({uSel:"NEW",id:"",pwd:"",result:"",biometric:"css/img/ImageBiometric.png",selection:"",srv:"",msgStatus:"NONE",msg:"",device:t});e.getView().setModel(n,"signOffModel");var i=this.getOwnerComponent().getModel("SSOLogin");if(i){this._validateResult(i.getData())}}catch(e){o.error("Exception in onInit function");this.handleException(e)}},onUserIdClk:function(){try{var e=this.getView().getModel("signOffModel");e.setProperty("/uSel","NEW");e.setProperty("/msgStatus","NONE");e.setProperty("/msg","");e.refresh()}catch(e){o.error("Exception in onInit function")}},onUserSelectNextBtnClk:function(e,t){try{var n=this;setTimeout(function(){n.getView().byId("ipPassword").focus()},100);n._resetSignOffError();if(n._validateSignOffUserinfo()){return}var i=n.getView().getModel("signOffModel");i.setProperty("/uSel",e);i.refresh()}catch(e){o.error("Exception in onInit function")}},onSubmitLoginClk:function(e,t){try{var n=this;if(e!=="PWDPRS"){this.handleBusyDialogOpen("Place finger on reader and hold.")}setTimeout(function(){var t=e==="PWDPRS"?n._fnUserPinLogin(n,e,""):n._fnUserPinLogin(n,e,"Y")},100)}catch(e){o.error("Exception in onSubmitLoginClk function");this.handleException(e)}},onAfterRendering:function(){var e=this;setTimeout(function(){e.getView().byId("ipUserID").focus()},100)},_fnUserBioLogin:function(e,t){try{var i=e.getView().getModel("signOffModel");i=this.getView().getModel("signOffModel");i.setProperty("/biometric","css/img/ImageBiometricS.png");i.setProperty("/uSel",t);i.refresh();n.show("SignOff Success");e.onUserIdClk()}catch(e){o.error("Exception in onInit function")}},_fnUserPinLogin:function(e,t,n){try{var r=e.getView().getModel("signOffModel");if(n!=="Y"&&e._validateSignPin()){return}if(n!=="Y"){this.fingerErrorCount=0}e._resetSignOffError();var s=i.destination+"/ws_authenticate";var a={Authorization:"Basic "+i._AESHexEncript(r.getProperty("/id")+":"+r.getProperty("/pwd")),BiometricAuth:i._AESHexEncript(n),state:"new"};var l=this.fnLogin("GET",s,a);if(n==="Y"){e.handleBusyDialogClose()}if(l){if(l.type==="SUCCESS"){e.handleBusyDialogClose();e._validateResult(l)}if(l.type==="ERROR"){e.handleBusyDialogClose();e._fnCheckFingerprintLogin(e)}}}catch(e){o.error("Exception in _fnUserPinLogin function")}},_fnCheckFingerprintLogin:function(e){this.fingerErrorCount++;if(this.fingerErrorCount>2){this.fingerErrorCount=0;e.getModel("signOffModel").setProperty("/uSel","PWD");e.getModel("signOffModel").refresh();return false}return true},_validateResult:function(e){try{if(this.busyDialog){this.busyDialog.close()}if(e.res!==undefined){e=e.res;if(e.length===0){r.show(this.getResourceBundle().getText("noPlatform"));return null}}i.setDataSet("oUserSession",{sessionid:e.length>0?e[0].SESSIONID:"",username:e.length>0?e[0].USERNAME:""});if(e.length===1){this._fnPlatformSelLogin(e[0].ROLENAME);return null}this.getView().setModel(new t(e),"loginModel");var n=this.openDialog("Platform")}catch(e){o.error("Exception in _validateResult function");this.handleException(e)}},fnAddPlatformToDialog:function(){this.getFragmentControl("PlatformId","CBPlatformSelection").removeAllButtons();this.getModel("signOffModel").getProperty("/pltform").forEach(function(e){this.getFragmentControl("PlatformId","CBPlatformSelection").addButton(new sap.m.RadioButton({text:e.PLATFORM}))}.bind(this))},onPlatformSelect:function(e){try{var t=this.getFragmentControl("PlatformId","CBPlatformSelection").getSelectedButton().getBindingContext("loginModel").getObject("ROLENAME");if(!t){r.show(this.getResourceBundle().getText("noPlatform"));return null}this.closeDialog("Platform");this._fnPlatformSelLogin(t)}catch(e){o.error("Exception in onPlatformSelect function");this.handleException(e)}},_fnPlatformSelLogin:function(e){try{$.ajax({type:"GET",url:i.destination+"/ws_authenticate",headers:{state:"selPtfm",ptfm:e},error:function(e){var t="Error";if(e.status===500||e.status===401){t=e.responseJSON[0].ErrorMsg}r.error(t)},success:function(e,t,n){var r=i.getDataSet("oUserSession");i.username=e.length>0?e[0].PLATFORM:"";i.setDataSet("oUserSession",r);sap.m.URLHelper.redirect(n.getResponseHeader("Location"),false)}.bind(this)})}catch(e){o.error("Exception in onInit function")}},_resetSignOffError:function(){try{var e=this.getView().getModel("signOffModel");e.setProperty("/msg","");e.setProperty("/msgStatus","NONE");e.refresh();if(!this.getView().byId("ipUserID")){return}this.getView().byId("ipUserID").setValueState("None");this.getView().byId("ipPassword").setValueState("None")}catch(e){o.error("Exception in onInit function")}},_validateSignOffUserinfo:function(){try{return this.getView().getModel("signOffModel").getProperty("/id").length<1?this._setSignOffError("ipUserID"):false}catch(e){o.error("Exception in onInit function")}},_validateSignPin:function(){try{return this.getView().getModel("signOffModel").getProperty("/pwd").length<3?this._setSignOffError("ipPassword"):false}catch(e){o.error("Exception in onInit function")}},_setSignOffError:function(e){try{var t=this.getView().byId(e);t.setValueState(sap.ui.core.ValueState.Error);if(t.getValueStateText()!==undefined&&t.getValueStateText()!==""&&t.getValueStateText().length>1){t.setValueStateText(t.getValueStateText())}return true}catch(e){o.error("Exception in onInit function")}},fnLogin:function(e,t,n,i){var o={},s=this;$.ajax({type:e,url:t,headers:n,async:false,error:function(e){i=i===false?false:true;if(i){var t="Error";if(e.status===500||e.status===401){t=e.responseJSON[0].ErrorMsg}if(s.fingerErrorCount>1){t="Fingerprint not matched. Login with password."}r.error(t)}var n={type:"ERROR",xhr:e};o=n},success:function(e,t,n){var i={type:"SUCCESS",res:e,status:t,xhr:n};o=i}});return o},getInitModel:function(){try{var e=jQuery.sap.getUriParameters().get("device");e=e!==null&&e.length>0?e:"default";var t={uSel:"NEW",id:"",pwd:"",result:"",biometric:"css/img/ImageBiometric.png",selection:"",srv:"",msgStatus:"NONE",msg:"",invalidCount:0,device:e};return t}catch(e){o.error("Exception in getInitModel function");this.handleException(e)}}})});